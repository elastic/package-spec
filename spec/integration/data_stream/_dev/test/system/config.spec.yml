##
## Describes the specification for a system test configuration file
##
spec:
  # Everything under here follows JSON schema (https://json-schema.org/), written as YAML for readability
  type: object
  additionalProperties: true
  properties:
    skip:
      $ref: "./../skip.spec.yml#/definitions/skip"
    wait_for_data_timeout:
      description: Timeout for waiting for metrics data during a system test.
      type: string
      example: 10m
    agent:
      description: "Configuration overrides for the Elastic Agent"
      type: object
      additionalProperties: false
      properties:
        runtime:
          description: "Runtime to run the Elastic Agent process"
          type: string
          enum:
            - docker
          default: docker
        user:
          description: "User that runs the Elastic Agent process"
          type: string
          example: root
          default: ""
        pid_mode:
          description: >
            (From docker-compose docs) Turns on sharing between container and the host
            operating system the PID address space
          type: string
          enum:
            - host
        ports:
          description: "List of ports to be exposed to access to the Elastic Agent"
          type: array
          items:
            type: string
            description: Port to be exposed, as defined in https://docs.docker.com/compose/compose-file/compose-file-v2/#ports
            examples:
              - "3000"
              - "8000:8000"
              - "127.0.0.1:7443:7443"
              - "8000:8000/udp"
        linux_capabilities:
          description: "Linux Capabilities that must been enabled in the system to run the Elastic Agent process"
          type: array
          items:
            type: string
            description: Capability name
            # https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities
            enum:
              - AUDIT_CONTROL
              - AUDIT_READ
              - AUDIT_WRITE
              - BLOCK_SUSPEND
              - BPF
              - CHECKPOINT_RESTORE
              - CHOWN
              - DAC_OVERRIDE
              - DAC_READ_SEARCH
              - FOWNER
              - FSETID
              - IPC_LOCK
              - IPC_OWNER
              - KILL
              - LEASE
              - LINUX_IMMUTABLE
              - MAC_ADMIN
              - MAC_OVERRIDE
              - MKNOD
              - NET_ADMIN
              - NET_BIND_SERVICE
              - NET_BROADCAST
              - NET_RAW
              - PERFORM
              - SETFCAP
              - SETGID
              - SETPCAP
              - SETUID
              - SYS_ADMIN
              - SYS_BOOT
              - SYS_CHROOT
              - SYS_MODULE
              - SYS_NICE
              - SYS_PACCT
              - SYS_PTRACE
              - SYS_RAWIO
              - SYS_RESOURCE
              - SYS_TIME
              - SYS_TTY_CONFIG
              - SYSLOG
              - WAKE_ALARM
            examples:
              - AUDIT_CONTROL
              - AUDIT_READ
        provisioning_script:
          description: "Optional: Custom script to be run to update environment where Elastic Agent runs (e.g. installing new libraries/dependencies)"
          type: object
          additionalProperties: false
          properties:
            language:
              description: "Programming language to run the script."
              type: string
              examples:
                - "bash"
                - "python"
              default: "bash"
            contents:
              description: "Contents of the script."
              type: string
              default: ""
        pre_start_script:
          description: "Optional: Custom sh script to be run to set required changes for the Elastic Agent process (e.g. export environment variables)"
          type: object
          additionalProperties: false
          properties:
            language:
              description: "Programming language to run the script. Currently, just supported \"sh\"."
              type: string
              enum:
               - sh
              default: sh
            contents:
              description: "Contents of the script."
              type: string
              default: ""
